const form=document.getElementById("bookForm"), titleInput=document.getElementById("bookTitle"), coverInput=document.getElementById("bookCover"), gallery=document.getElementById("gallery"), darkToggle=document.getElementById("darkModeToggle"), cache=new Map();
function saveBooks(books) {
	localStorage.setItem("books",JSON.stringify(books));
}
function loadBooks() {
	return JSON.parse(localStorage.getItem("books"))||[];
}
function renderBooks() {
	gallery.innerHTML="";
	loadBooks().forEach(({title,url})=> {
		const img=new Image;
		img.alt=title,img.loading="lazy",getImage(url).then(src=>img.src=src);
		gallery.appendChild(img);
	})
}
function getImage(url) {
	return cache.has(url)?Promise.resolve(cache.get(url)):fetch(url).then(r=>r.blob()).then(b=> {
		const src=URL.createObjectURL(b);
		return cache.set(url,src),src;
	})
}
form.addEventListener("submit",e=> {
	e.preventDefault();
	const title=titleInput.value.trim(),url=coverInput.value.trim();if(!title||!url)return;
	const books=loadBooks();
	books.push({title,url}),saveBooks(books),renderBooks(),form.reset();
}),window.addEventListener("load",()=> {
	renderBooks();
	const theme=localStorage.getItem("theme");
	"dark"===theme&&(document.body.classList.add("dark"),darkToggle.checked=!0);
}),darkToggle.addEventListener("change",()=> {
	document.body.classList.toggle("dark"),localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");
})